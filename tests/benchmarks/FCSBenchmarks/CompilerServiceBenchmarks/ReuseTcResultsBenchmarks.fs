namespace FSharp.Compiler.Benchmarks

open System
open System.IO
open BenchmarkDotNet.Attributes
open FSharp.Compiler.CodeAnalysis
open FSharp.Test.ProjectGeneration
open FSharp.Benchmarks.Common.Categories

[<MemoryDiagnoser>]
[<BenchmarkCategory(ShortCategory)>]
type ReuseTcResultsBenchmarks() =

    let getShortId() = Guid.NewGuid().ToString().[..7]

    let source = """namespace N
module M1 = ()
module M2 = ()
module M3 = ()
module M4 = ()
module M5 = ()
module M6 = ()
module M7 = ()
module M8 = ()
module M9 = ()
module M10 = ()
module M11 = ()
module M12 = ()
module M13 = ()
module M14 = ()
module M15 = ()
module M16 = ()
module M17 = ()
module M18 = ()
module M19 = ()
module M20 = ()
module M21 = ()
module M22 = ()
module M23 = ()
module M24 = ()
module M25 = ()
module M26 = ()
module M27 = ()
module M28 = ()
module M29 = ()
module M30 = ()
module M31 = ()
module M32 = ()
module M33 = ()
module M34 = ()
module M35 = ()
module M36 = ()
module M37 = ()
module M38 = ()
module M39 = ()
module M40 = ()
module M41 = ()
module M42 = ()
module M43 = ()
module M44 = ()
module M45 = ()
module M46 = ()
module M47 = ()
module M48 = ()
module M49 = ()
module M50 = ()
module M51 = ()
module M52 = ()
module M53 = ()
module M54 = ()
module M55 = ()
module M56 = ()
module M57 = ()
module M58 = ()
module M59 = ()
module M60 = ()
module M61 = ()
module M62 = ()
module M63 = ()
module M64 = ()
module M65 = ()
module M66 = ()
module M67 = ()
module M68 = ()
module M69 = ()
module M70 = ()
module M71 = ()
module M72 = ()
module M73 = ()
module M74 = ()
module M75 = ()
module M76 = ()
module M77 = ()
module M78 = ()
module M79 = ()
module M80 = ()
module M81 = ()
module M82 = ()
module M83 = ()
module M84 = ()
module M85 = ()
module M86 = ()
module M87 = ()
module M88 = ()
module M89 = ()
module M90 = ()
module M91 = ()
module M92 = ()
module M93 = ()
module M94 = ()
module M95 = ()
module M96 = ()
module M97 = ()
module M98 = ()
module M99 = ()
module M100 = ()
module M101 = ()
module M102 = ()
module M103 = ()
module M104 = ()
module M105 = ()
module M106 = ()
module M107 = ()
module M108 = ()
module M109 = ()
module M110 = ()
module M111 = ()
module M112 = ()
module M113 = ()
module M114 = ()
module M115 = ()
module M116 = ()
module M117 = ()
module M118 = ()
module M119 = ()
module M120 = ()
module M121 = ()
module M122 = ()
module M123 = ()
module M124 = ()
module M125 = ()
module M126 = ()
module M127 = ()
module M128 = ()
module M129 = ()
module M130 = ()
module M131 = ()
module M132 = ()
module M133 = ()
module M134 = ()
module M135 = ()
module M136 = ()
module M137 = ()
module M138 = ()
module M139 = ()
module M140 = ()
module M141 = ()
module M142 = ()
module M143 = ()
module M144 = ()
module M145 = ()
module M146 = ()
module M147 = ()
module M148 = ()
module M149 = ()
module M150 = ()
module M151 = ()
module M152 = ()
module M153 = ()
module M154 = ()
module M155 = ()
module M156 = ()
module M157 = ()
module M158 = ()
module M159 = ()
module M160 = ()
module M161 = ()
module M162 = ()
module M163 = ()
module M164 = ()
module M165 = ()
module M166 = ()
module M167 = ()
module M168 = ()
module M169 = ()
module M170 = ()
module M171 = ()
module M172 = ()
module M173 = ()
module M174 = ()
module M175 = ()
module M176 = ()
module M177 = ()
module M178 = ()
module M179 = ()
module M180 = ()
module M181 = ()
module M182 = ()
module M183 = ()
module M184 = ()
module M185 = ()
module M186 = ()
module M187 = ()
module M188 = ()
module M189 = ()
module M190 = ()
module M191 = ()
module M192 = ()
module M193 = ()
module M194 = ()
module M195 = ()
module M196 = ()
module M197 = ()
module M198 = ()
module M199 = ()
module M200 = ()
module M201 = ()
module M202 = ()
module M203 = ()
module M204 = ()
module M205 = ()
module M206 = ()
module M207 = ()
module M208 = ()
module M209 = ()
module M210 = ()
module M211 = ()
module M212 = ()
module M213 = ()
module M214 = ()
module M215 = ()
module M216 = ()
module M217 = ()
module M218 = ()
module M219 = ()
module M220 = ()
module M221 = ()
module M222 = ()
module M223 = ()
module M224 = ()
module M225 = ()
module M226 = ()
module M227 = ()
module M228 = ()
module M229 = ()
module M230 = ()
module M231 = ()
module M232 = ()
module M233 = ()
module M234 = ()
module M235 = ()
module M236 = ()
module M237 = ()
module M238 = ()
module M239 = ()
module M240 = ()
module M241 = ()
module M242 = ()
module M243 = ()
module M244 = ()
module M245 = ()
module M246 = ()
module M247 = ()
module M248 = ()
module M249 = ()
module M250 = ()
module M251 = ()
module M252 = ()
module M253 = ()
module M254 = ()
module M255 = ()
module M256 = ()
module M257 = ()
module M258 = ()
module M259 = ()
module M260 = ()
module M261 = ()
module M262 = ()
module M263 = ()
module M264 = ()
module M265 = ()
module M266 = ()
module M267 = ()
module M268 = ()
module M269 = ()
module M270 = ()
module M271 = ()
module M272 = ()
module M273 = ()
module M274 = ()
module M275 = ()
module M276 = ()
module M277 = ()
module M278 = ()
module M279 = ()
module M280 = ()
module M281 = ()
module M282 = ()
module M283 = ()
module M284 = ()
module M285 = ()
module M286 = ()
module M287 = ()
module M288 = ()
module M289 = ()
module M290 = ()
module M291 = ()
module M292 = ()
module M293 = ()
module M294 = ()
module M295 = ()
module M296 = ()
module M297 = ()
module M298 = ()
module M299 = ()
module M300 = ()
module M301 = ()
module M302 = ()
module M303 = ()
module M304 = ()
module M305 = ()
module M306 = ()
module M307 = ()
module M308 = ()
module M309 = ()
module M310 = ()
module M311 = ()
module M312 = ()
module M313 = ()
module M314 = ()
module M315 = ()
module M316 = ()
module M317 = ()
module M318 = ()
module M319 = ()
module M320 = ()
module M321 = ()
module M322 = ()
module M323 = ()
module M324 = ()
module M325 = ()
module M326 = ()
module M327 = ()
module M328 = ()
module M329 = ()
module M330 = ()
module M331 = ()
module M332 = ()
module M333 = ()
module M334 = ()
module M335 = ()
module M336 = ()
module M337 = ()
module M338 = ()
module M339 = ()
module M340 = ()
module M341 = ()
module M342 = ()
module M343 = ()
module M344 = ()
module M345 = ()
module M346 = ()
module M347 = ()
module M348 = ()
module M349 = ()
module M350 = ()
module M351 = ()
module M352 = ()
module M353 = ()
module M354 = ()
module M355 = ()
module M356 = ()
module M357 = ()
module M358 = ()
module M359 = ()
module M360 = ()
module M361 = ()
module M362 = ()
module M363 = ()
module M364 = ()
module M365 = ()
module M366 = ()
module M367 = ()
module M368 = ()
module M369 = ()
module M370 = ()
module M371 = ()
module M372 = ()
module M373 = ()
module M374 = ()
module M375 = ()
module M376 = ()
module M377 = ()
module M378 = ()
module M379 = ()
module M380 = ()
module M381 = ()
module M382 = ()
module M383 = ()
module M384 = ()
module M385 = ()
module M386 = ()
module M387 = ()
module M388 = ()
module M389 = ()
module M390 = ()
module M391 = ()
module M392 = ()
module M393 = ()
module M394 = ()
module M395 = ()
module M396 = ()
module M397 = ()
module M398 = ()
module M399 = ()
module M400 = ()
module M401 = ()
module M402 = ()
module M403 = ()
module M404 = ()
module M405 = ()
module M406 = ()
module M407 = ()
module M408 = ()
module M409 = ()
module M410 = ()
module M411 = ()
module M412 = ()
module M413 = ()
module M414 = ()
module M415 = ()
module M416 = ()
module M417 = ()
module M418 = ()
module M419 = ()
module M420 = ()
module M421 = ()
module M422 = ()
module M423 = ()
module M424 = ()
module M425 = ()
module M426 = ()
module M427 = ()
module M428 = ()
module M429 = ()
module M430 = ()
module M431 = ()
module M432 = ()
module M433 = ()
module M434 = ()
module M435 = ()
module M436 = ()
module M437 = ()
module M438 = ()
module M439 = ()
module M440 = ()
module M441 = ()
module M442 = ()
module M443 = ()
module M444 = ()
module M445 = ()
module M446 = ()
module M447 = ()
module M448 = ()
module M449 = ()
module M450 = ()
module M451 = ()
module M452 = ()
module M453 = ()
module M454 = ()
module M455 = ()
module M456 = ()
module M457 = ()
module M458 = ()
module M459 = ()
module M460 = ()
module M461 = ()
module M462 = ()
module M463 = ()
module M464 = ()
module M465 = ()
module M466 = ()
module M467 = ()
module M468 = ()
module M469 = ()
module M470 = ()
module M471 = ()
module M472 = ()
module M473 = ()
module M474 = ()
module M475 = ()
module M476 = ()
module M477 = ()
module M478 = ()
module M479 = ()
module M480 = ()
module M481 = ()
module M482 = ()
module M483 = ()
module M484 = ()
module M485 = ()
module M486 = ()
module M487 = ()
module M488 = ()
module M489 = ()
module M490 = ()
module M491 = ()
module M492 = ()
module M493 = ()
module M494 = ()
module M495 = ()
module M496 = ()
module M497 = ()
module M498 = ()
module M499 = ()
module M500 = ()
module M501 = ()
module M502 = ()
module M503 = ()
module M504 = ()
module M505 = ()
module M506 = ()
module M507 = ()
module M508 = ()
module M509 = ()
module M510 = ()
module M511 = ()
module M512 = ()
module M513 = ()
module M514 = ()
module M515 = ()
module M516 = ()
module M517 = ()
module M518 = ()
module M519 = ()
module M520 = ()
module M521 = ()
module M522 = ()
module M523 = ()
module M524 = ()
module M525 = ()
module M526 = ()
module M527 = ()
module M528 = ()
module M529 = ()
module M530 = ()
module M531 = ()
module M532 = ()
module M533 = ()
module M534 = ()
module M535 = ()
module M536 = ()
module M537 = ()
module M538 = ()
module M539 = ()
module M540 = ()
module M541 = ()
module M542 = ()
module M543 = ()
module M544 = ()
module M545 = ()
module M546 = ()
module M547 = ()
module M548 = ()
module M549 = ()
module M550 = ()
module M551 = ()
module M552 = ()
module M553 = ()
module M554 = ()
module M555 = ()
module M556 = ()
module M557 = ()
module M558 = ()
module M559 = ()
module M560 = ()
module M561 = ()
module M562 = ()
module M563 = ()
module M564 = ()
module M565 = ()
module M566 = ()
module M567 = ()
module M568 = ()
module M569 = ()
module M570 = ()
module M571 = ()
module M572 = ()
module M573 = ()
module M574 = ()
module M575 = ()
module M576 = ()
module M577 = ()
module M578 = ()
module M579 = ()
module M580 = ()
module M581 = ()
module M582 = ()
module M583 = ()
module M584 = ()
module M585 = ()
module M586 = ()
module M587 = ()
module M588 = ()
module M589 = ()
module M590 = ()
module M591 = ()
module M592 = ()
module M593 = ()
module M594 = ()
module M595 = ()
module M596 = ()
module M597 = ()
module M598 = ()
module M599 = ()
module M600 = ()
module M601 = ()
module M602 = ()
module M603 = ()
module M604 = ()
module M605 = ()
module M606 = ()
module M607 = ()
module M608 = ()
module M609 = ()
module M610 = ()
module M611 = ()
module M612 = ()
module M613 = ()
module M614 = ()
module M615 = ()
module M616 = ()
module M617 = ()
module M618 = ()
module M619 = ()
module M620 = ()
module M621 = ()
module M622 = ()
module M623 = ()
module M624 = ()
module M625 = ()
module M626 = ()
module M627 = ()
module M628 = ()
module M629 = ()
module M630 = ()
module M631 = ()
module M632 = ()
module M633 = ()
module M634 = ()
module M635 = ()
module M636 = ()
module M637 = ()
module M638 = ()
module M639 = ()
module M640 = ()
module M641 = ()
module M642 = ()
module M643 = ()
module M644 = ()
module M645 = ()
module M646 = ()
module M647 = ()
module M648 = ()
module M649 = ()
module M650 = ()
module M651 = ()
module M652 = ()
module M653 = ()
module M654 = ()
module M655 = ()
module M656 = ()
module M657 = ()
module M658 = ()
module M659 = ()
module M660 = ()
module M661 = ()
module M662 = ()
module M663 = ()
module M664 = ()
module M665 = ()
module M666 = ()
module M667 = ()
module M668 = ()
module M669 = ()
module M670 = ()
module M671 = ()
module M672 = ()
module M673 = ()
module M674 = ()
module M675 = ()
module M676 = ()
module M677 = ()
module M678 = ()
module M679 = ()
module M680 = ()
module M681 = ()
module M682 = ()
module M683 = ()
module M684 = ()
module M685 = ()
module M686 = ()
module M687 = ()
module M688 = ()
module M689 = ()
module M690 = ()
module M691 = ()
module M692 = ()
module M693 = ()
module M694 = ()
module M695 = ()
module M696 = ()
module M697 = ()
module M698 = ()
module M699 = ()
module M700 = ()
module M701 = ()
module M702 = ()
module M703 = ()
module M704 = ()
module M705 = ()
module M706 = ()
module M707 = ()
module M708 = ()
module M709 = ()
module M710 = ()
module M711 = ()
module M712 = ()
module M713 = ()
module M714 = ()
module M715 = ()
module M716 = ()
module M717 = ()
module M718 = ()
module M719 = ()
module M720 = ()
module M721 = ()
module M722 = ()
module M723 = ()
module M724 = ()
module M725 = ()
module M726 = ()
module M727 = ()
module M728 = ()
module M729 = ()
module M730 = ()
module M731 = ()
module M732 = ()
module M733 = ()
module M734 = ()
module M735 = ()
module M736 = ()
module M737 = ()
module M738 = ()
module M739 = ()
module M740 = ()
module M741 = ()
module M742 = ()
module M743 = ()
module M744 = ()
module M745 = ()
module M746 = ()
module M747 = ()
module M748 = ()
module M749 = ()
module M750 = ()
module M751 = ()
module M752 = ()
module M753 = ()
module M754 = ()
module M755 = ()
module M756 = ()
module M757 = ()
module M758 = ()
module M759 = ()
module M760 = ()
module M761 = ()
module M762 = ()
module M763 = ()
module M764 = ()
module M765 = ()
module M766 = ()
module M767 = ()
module M768 = ()
module M769 = ()
module M770 = ()
module M771 = ()
module M772 = ()
module M773 = ()
module M774 = ()
module M775 = ()
module M776 = ()
module M777 = ()
module M778 = ()
module M779 = ()
module M780 = ()
module M781 = ()
module M782 = ()
module M783 = ()
module M784 = ()
module M785 = ()
module M786 = ()
module M787 = ()
module M788 = ()
module M789 = ()
module M790 = ()
module M791 = ()
module M792 = ()
module M793 = ()
module M794 = ()
module M795 = ()
module M796 = ()
module M797 = ()
module M798 = ()
module M799 = ()
module M800 = ()"""

    // Temporary directory is TempPath + "/FSharp.Test.Utilities/xxxxxxx/"
    let tempDirectoryOfThisTestRun() =
        let temp = Path.GetTempPath()
        DirectoryInfo(temp).CreateSubdirectory($"FSharp.Test.Utilities/{getShortId()}")

    let createTemporaryDirectory () =
        tempDirectoryOfThisTestRun()
            .CreateSubdirectory($"{getShortId()}")

    let getTemporaryFileName () =
        createTemporaryDirectory().FullName ++ getShortId()

    member val Benchmark = Unchecked.defaultof<_> with get, set

    member this.setup(project) =
        let checker = FSharpChecker.Create()
        this.Benchmark <- ProjectWorkflowBuilder(project, checker = checker).CreateBenchmarkBuilder()
        saveProject project false checker |> Async.RunSynchronously

    [<Benchmark>]
    member this.NoReuse() = 
        this.setup
            { SyntheticProject.Create() with
                SourceFiles =
                    [
                        { 
                              Id = "Test"
                              PublicVersion = 1
                              InternalVersion = 1
                              DependsOn = []
                              FunctionName = "f"
                              SignatureFile = No
                              HasErrors = false
                              Source = source
                              ExtraSource = ""
                              EntryPoint = false
                              IsPhysicalFile = true 
                        }
                    ]
                OtherOptions =
                    [
                        "--compressmetadata-"
                        "--optimize-"
                    ]
                SkipInitialCheck = true
                AutoAddModules = false
            }

        this.Benchmark { 
            compileWithFSC 
            compileWithFSC 
        }

    [<Benchmark>]
    member this.Reuse() =
        this.setup
            { SyntheticProject.Create() with
                SourceFiles =
                    [
                        { 
                              Id = "Test"
                              PublicVersion = 1
                              InternalVersion = 1
                              DependsOn = []
                              FunctionName = "f"
                              SignatureFile = No
                              HasErrors = false
                              Source = source
                              ExtraSource = ""
                              EntryPoint = false
                              IsPhysicalFile = true 
                        }
                    ]
                OtherOptions =
                    [
                        "--compressmetadata-"
                        "--optimize-"
                        "--reusetypecheckingresults"
                    ]
                SkipInitialCheck = true
                AutoAddModules = false
            }

        this.Benchmark { 
            compileWithFSC 
            compileWithFSC 
        }
